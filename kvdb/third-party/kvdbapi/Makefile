# A sample Makefile for building Google Test and using it in user
# tests.  Please tweak it to suit your environment and project.  You
# may want to move it to your project's root directory.
#
# SYNOPSIS:
#
#   make [all]  - makes everything.
#   make TARGET - makes the given target.
#   make clean  - removes all files generated by make.

# Please tweak the following variable definitions as needed by your
# project, except GTEST_HEADERS, which you can use in your own targets
# but shouldn't modify.

# Points to the root of Google Test, relative to where this file is.
# Remember to tweak this if you move this file.
PROJECT_DIR = ..
INCLUDES_DIR = ../..
INSDB_INCLUDE_DIR = ../../../
GENERIC_SRC_DIR = $(PROJECT_DIR)/generic/src
GENERIC_INC_DIR = $(PROJECT_DIR)/generic/include
//GENERIC_INSDB_DIR = $(INSDB_INCLUDE_DIR)/insdb/insdb/insdb-master/include
GENERIC_INSDB_DIR = $(INSDB_INCLUDE_DIR)/insdb/include
# where to fine the tool headers and libraries.
TOOL_DIR = $(PROJECT_DIR)/deps
TOOL_INCLUDE_DIR = $(INCLUDES_DIR)/include
CC  = gcc
CXX = g++
OPT = -g
#DEFS = FORMAT
WARNINGS = -fpermissive -Wall -Wextra

# Where to find user code.
SRC_DIR = $(PROJECT_DIR)/kvdbapi

# Flags passed to the C++ compiler.
CXXFLAGS = $(OPT) $(WARNINGS) -Wl,--no-as-needed -pthread -lrt -liberty -lsnappy -lfolly -ldl -lglog -ldouble-conversion -DROCKSDB_PLATFORM_POSIX
#CXXFLAGS = $(WARNINGS) -Wl,--no-as-needed -pthread -lrt -lkvdb_static -linsdb -lsnappy -lfolly -ldl -lglog -ldouble-conversion
# libraries used as parts of compiling dependences
DEP_LIBS = $(TOOL_DIR)/gtest/lib/libgtest.a
DEP_LIBS += $(TOOL_DIR)/kvdb/lib/libkvdb_static.a
#DEP_LIBS += /home/kvhs/ddtest/kvdb/build/libkvdb_static.a
#DEP_LIBS += /home/kvhs/ddtest/insdb/insdb/insdb-master/out-static/libinsdb.a
#DEP_LIBS += $(TOOL_DIR)/kvdb/lib/libkvdb.so
DEP_LIBS += $(TOOL_DIR)/kvdb/lib/libinsdb.a
DEP_LIBS += $(TOOL_DIR)/kvdb/lib/libsnappy.a
DEP_LIBS += $(TOOL_DIR)/kvdb/lib/libfolly.a
DEP_LIBS += $(TOOL_DIR)/kvdb/lib/libdouble-conversion.a
DEP_LIBS += $(TOOL_DIR)/libxml2/lib/libxml2.a
DEP_LIBS += $(TOOL_DIR)/glog/lib/libglog.so
DEP_LIBS += /usr/lib/x86_64-linux-gnu/libiberty.a
CXXFLAGS += -std=gnu++11
CXXFLAGS += -O3
# All tests produced by this Makefile.  Remember to add new tests you
# created to the list.
KV_BIN = kvdbapi_unit_all
#FORMAT_OPTION = -D$(DEFS)

ifdef noformat
KV_BIN = kvstore_nf
#FORMAT_OPTION =
endif

# All Google Test header path.  Usually you shouldn't change this
# definition.
GTEST_HEAD = $(TOOL_DIR)/gtest/include

# All Key Value Engine APIs' header path. Usually you shouldn't change this
# definition.
KVE_API_HEAD = $(TOOL_INCLUDE_DIR)/rocksdb
KKVE_API_HEAD_KVDB = $(INCLUDES_DIR)/kvdb
KVE_KVSSD_HEAD = $(TOOL_INCLUDE_DIR)/rocksdb/utilities
KV_HEAD = $(TOOL_INCLUDE_DIR)/
KV_HEADA = $(INCLUDES_DIR)/

# libxml2 header file directory
XML_LIB_HEAD = $(TOOL_DIR)/libxml2/include

# glog head file directory
GLOG_HEAD = $(TOOL_DIR)/glog/include

# User tool specific Flags. Usually you shouldn't change this definition.
INCLUDES += -I $(GENERIC_INC_DIR) -I $(GTEST_HEAD)  \
            -I $(KV_HEAD)  -I $(KVE_KVSSD_HEAD) \
			-I $(KVE_API_HEAD) -I $(XML_LIB_HEAD) \
			-I $(GLOG_HEAD) -I $(KKVE_API_HEAD_KVDB) -I $(GENERIC_INSDB_DIR) -I $(KV_HEADA)

# list generic files
GENERIC_LIST = $(GENERIC_SRC_DIR)/Main.cc \
               $(GENERIC_SRC_DIR)/Common.cc \
               $(GENERIC_SRC_DIR)/XMLParser.cc \
               $(GENERIC_SRC_DIR)/LogFile.cc

# list source files
#SRC_LIST = $(wildcard $(SRC_DIR)/*.cc)
SRC_LIST =$(SRC_DIR)/kvdb_open.cc \
           $(SRC_DIR)/kvdb_put.cc \
           $(SRC_DIR)/kvdb_get.cc \
           $(SRC_DIR)/kvdb_writeBatch.cc \
	   $(SRC_DIR)/kvdb_snapshot.cc \
           $(SRC_DIR)/kvdb_writebatch_with_index_test.cc \
           $(SRC_DIR)/kvdb_column_family.cc \
           $(SRC_DIR)/kvdb_flush.cc \
           $(SRC_DIR)/kvdb_compression.cc \
           $(SRC_DIR)/kvdb_comparator.cc \
           $(SRC_DIR)/kvdb_ttl.cc \
           $(SRC_DIR)/kvdb_crc32.cc
#           $(SRC_DIR)/kvdb_delete.cc \
           $(SRC_DIR)/kvdb_NewIterator.cc
#           $(SRC_DIR)/kvdb_prefix.cc \
           $(SRC_DIR)/kvdb_transaction.cc \
#SRC_LIST =$(SRC_DIR)/iter_multi_delete.cc
#SRC_LIST =$(SRC_DIR)/kvdb_checkpoint.cc
#SRC_LIST =$(SRC_DIR)/kvdb_non_blocking_get.cc
#SRC_LIST =$(SRC_DIR)/kvdb_getApproximateSize.cc
#SRC_LIST =$(SRC_DIR)/kvdb_ttl.cc
#SRC_LIST =$(SRC_DIR)/kvdb_comparator.cc
#SRC_LIST =$(SRC_DIR)/kvdb_compression.cc
#SRC_LIST =$(SRC_DIR)/kvdb_crc32.cc
#SRC_LIST =$(SRC_DIR)/kvdb_basic_test.cc
#SRC_LIST =$(SRC_DIR)/kvdb_snapshot.cc
#SRC_LIST =$(SRC_DIR)/kvdb_open.cc
#SRC_LIST =$(SRC_DIR)/kvdb_backup_test.cc
#SRC_LIST =$(SRC_DIR)/kvdb_get.cc
#SRC_LIST =$(SRC_DIR)/kvdb_put.cc
#SRC_LIST =$(SRC_DIR)/merge_helper_test.cc
#SRC_LIST =$(SRC_DIR)/merge_test.cc
#SRC_LIST =$(SRC_DIR)/kvdb_prefix.cc
#SRC_LIST =$(SRC_DIR)/kvdb_wal.cc
#SRC_LIST =$(SRC_DIR)/kvdb_flush.cc
#SRC_LIST =$(SRC_DIR)/kvdb_column_family.cc
#SRC_LIST =$(SRC_DIR)/kvdb_writeBatch.cc
#SRC_LIST =$(SRC_DIR)/write_batch_with_index_test.cc
#SRC_LIST =$(SRC_DIR)/slice_transform_test.cc
#SRC_LIST =$(SRC_DIR)/db_tailing_iter_test.cc
#SRC_LIST =$(SRC_DIR)/kvdb_transaction.cc
#SRC_LIST =$(SRC_DIR)/kvdb_compression_test.cc
#SRC_LIST =$(SRC_DIR)/kvdb_NewIterator.cc
#SRC_LIST = $(SRC_DIR)/kvdb_RateLimiter.cc
#SRC_LIST = $(SRC_DIR)/kvdb_checkpoint.cc
#SRC_LIST = $(SRC_DIR)/kvdb_iter_test.cc
#SRC_LIST =$(SRC_DIR)/kvdb_delete.cc
#SRC_LIST =$(SRC_DIR)/kvdb_crc32.cc
#SRC_LIST =$(SRC_DIR)/kvdb_get.cc \
          $(SRC_DIR)/kvdb_put.cc  \
          $(SRC_DIR)/kvdb_delete.cc \
          $(SRC_DIR)/kvdb_snapshot.cc
#SRC_LIST =$(SRC_DIR)/kvdb_snapshot.cc
#SRC_LIST =$(SRC_DIR)/kvdb_open.cc \
           $(SRC_DIR)/kvdb_put.cc \
           $(SRC_DIR)/kvdb_get.cc \
           $(SRC_DIR)/kvdb_delete.cc \
           $(SRC_DIR)/kvdb_writeBatch.cc \
           $(SRC_DIR)/kvdb_column_family.cc \
           $(SRC_DIR)/kvdb_snapshot2.cc \
           $(SRC_DIR)/kvdb_NewIterator.cc \
           $(SRC_DIR)/kvdb_crc_test.cc \
           $(SRC_DIR)/kvdb_transaction.cc \
           $(SRC_DIR)/kvdb_comparator.cc \
           $(SRC_DIR)/kvdb_compression.cc
OBJ_LIST = $(GENERIC_LIST:.cc=.o) $(SRC_LIST:.cc=.o)

all : $(KV_BIN)
$(KV_BIN) : $(OBJ_LIST) $(DEP_LIBS)
	$(CXX) $(CXXLIBS) $(CXXFLAGS) $^ -o $@

$(OBJ_LIST) : %.o : %.cc
	$(CXX) $(INCLUDES) $(CXXFLAGS) -c $^ -o $@

clear :
	rm -f $(SRC_DIR)/*.o $(GENERIC_SRC_DIR)/*.o

clean :
	rm -f $(KV_BIN) $(SRC_DIR)/*.o $(GENERIC_SRC_DIR)/*.o
